<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Console Sync - PeerJS</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body {
            font-family: "Benton Sans", "BentonSans", sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background-color: #f0f2f5;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* --- CONFIGURAZIONE LARGHEZZE --- */
        #colonna-input {
            width: 40%;
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-auto-rows: minmax(45px, auto);
            gap: 6px;
            background-color: #ffffff;
            border-right: 2px solid #2c3e50;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .btn-sigla {
            font-family: inherit;
            padding: 4px;
            font-weight: 600;
            border: 2px solid #bdc3c7;
            background: #fff;
            cursor: pointer;
            border-radius: 4px;
            text-transform: uppercase;
            transition: all 0.2s;
            font-size: clamp(0.7rem, 1.1vw, 1rem);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            word-break: break-word;
            line-height: 1.1;
            min-height: 45px;
        }

        .btn-sigla:hover { border-color: #95a5a6; background-color: #f7f9f9; }
        .btn-sigla.attivo-nella-colonna { background-color: #f39c12; color: white; border-color: #d35400; }

        #colonna-view {
            width: 30%;
            padding: 15px;
            background-color: #ecf0f1;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #2c3e50;
            box-sizing: border-box;
            height: 100%;
        }

        #colonna-view h3 {
            text-align: center;
            color: #2c3e50;
            margin: 0 0 10px 0;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 10px;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        #display-log {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 5px;
            scroll-behavior: smooth; 
        }

        .item-log {
            background: white;
            padding: 10px;
            border-radius: 6px;
            font-weight: 700;
            font-size: clamp(0.8rem, 1.2vw, 1.1rem); 
            color: #e74c3c;
            border-left: 5px solid #e74c3c;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            word-break: break-word;
            flex-shrink: 0;
        }

        #colonna-controlli {
            width: 30%;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #2c3e50;
            box-sizing: border-box;
            color: white;
            overflow-y: auto;
        }

        .logo-wrapper { width: 100%; display: flex; justify-content: center; margin-bottom: 5px; }
        .logo-wrapper img { max-width: 100%; height: auto; max-height: 70px; object-fit: contain; }

        .btn-select {
            font-family: inherit; padding: 10px; border: 2px solid transparent;
            background: #34495e; color: #bdc3c7; cursor: pointer;
            font-weight: 700; border-radius: 4px; font-size: 0.9rem;
        }
        .btn-select.active { background-color: #e74c3c; color: white; border-color: #ffffff; }

        .btn-save { padding: 12px; background-color: #27ae60; color: white; border: none; border-radius: 4px; font-weight: 700; cursor: pointer; margin-top: auto;}
        .btn-reset { padding: 10px; background-color: #c0392b; color: white; border: none; border-radius: 4px; font-weight: 700; cursor: pointer; }

        /* --- STILI PER LA SEZIONE PEERJS --- */
        .network-panel {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }
        .network-panel h4 { margin: 0 0 8px 0; color: #f1c40f; text-align: center; }
        .network-row { display: flex; flex-direction: column; gap: 5px; margin-bottom: 8px; }
        .id-display { 
            background: #fff; color: #333; padding: 5px; 
            font-family: monospace; text-align: center; border-radius: 3px; 
            cursor: copy; border: 1px solid #999;
        }
        .input-peer { padding: 5px; border-radius: 3px; border: none; font-family: monospace;}
        .btn-connect { background: #3498db; color: white; border: none; padding: 5px; border-radius: 3px; cursor: pointer; font-weight: bold;}
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px;}
        .status-online { background-color: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        #peer-status-text { font-size: 0.8rem; font-style: italic; }

    </style>
</head>
<body>

    <div id="colonna-input"></div>

    <div id="colonna-view">
        <h3 id="titolo-colonna">CAMBIO 1</h3>
        <div id="display-log"></div>
    </div>

    <div id="colonna-controlli">
        <div class="logo-wrapper">
            <img src="Logo 26.png" alt="Logo">
        </div>

        <div class="network-panel">
            <h4>üì° SINCRONIZZAZIONE LIVE</h4>
            
            <div class="network-row">
                <label>Il tuo ID (clicca per copiare):</label>
                <div id="my-id" class="id-display" onclick="copiaID()">In attesa...</div>
            </div>

            <div class="network-row">
                <label>Connetti a ID remoto:</label>
                <input type="text" id="remote-id" class="input-peer" placeholder="Incolla ID qui">
                <button class="btn-connect" onclick="connettiAPeer()">üîó CONNETTI</button>
            </div>

            <div style="margin-top: 5px;">
                <span id="status-dot" class="status-dot"></span>
                <span id="peer-status-text">Disconnesso</span>
            </div>
        </div>
        <button class="btn-select active" onclick="switchColonna(0)">CAMBIO 1</button>
        <button class="btn-select" onclick="switchColonna(1)">CAMBIO 2</button>
        <button class="btn-select" onclick="switchColonna(2)">CAMBIO 3</button>
        <button class="btn-select" onclick="switchColonna(3)">CAMBIO 4</button>
        <button class="btn-select" onclick="switchColonna(4)">CAMBIO 5</button>
        
        <button class="btn-save" onclick="salvaTutto()">üíæ SALVA REPORT</button>
        <button class="btn-reset" onclick="resetDati()">üóëÔ∏è RESET</button>
    </div>

    <script>
        // --- LOGICA DATI ---
        const nomi = ["BAIRO","BARBANIA", "BUSANO", "CANISCHIO", "CUCEGLIO", "CUORGNE'", "FAVRIA", "FORNO", "FRASSINETTO", "LEVONE", "OZEGNA", "PERTUSIO", "PRASCORSANO", "PRATIGLIONE","RIVARA", "RIVAROLO","OGLIANICO" ,"SPARONE", "TORRRE", "VALPERGA"];
        
        let savedData = localStorage.getItem('shared_log_data');
        let colonneData = savedData ? JSON.parse(savedData).data : [[], [], [], [], []];
        let colonnaAttiva = 0;

        // --- SETUP INTERFACCIA ---
        const inputPanel = document.getElementById('colonna-input');
        nomi.forEach(n => {
            const b = document.createElement('button');
            b.innerText = n;
            b.id = `btn-${n}`;
            b.className = 'btn-sigla';
            b.onclick = () => toggleTasto(n, true); // True = invia agli altri
            inputPanel.appendChild(b);
        });

        // --- FUNZIONI PRINCIPALI ---

        function toggleTasto(sigla, broadcast = true) {
            let colData = colonneData[colonnaAttiva];
            const index = colData.indexOf(sigla);
            if (index > -1) colData.splice(index, 1);
            else colData.push(sigla);
            
            syncAndRefresh();
            if(broadcast) inviaDati();
        }

        function switchColonna(idx) {
            colonnaAttiva = idx;
            document.getElementById('titolo-colonna').innerText = `CAMBIO ${idx + 1}`;
            document.querySelectorAll('.btn-select').forEach((b, i) => b.classList.toggle('active', i === idx));
            syncAndRefresh();
        }

        function syncAndRefresh() {
            // Aggiorna bottoni sinistra
            nomi.forEach(n => {
                const b = document.getElementById(`btn-${n}`);
                b.classList.toggle('attivo-nella-colonna', (colonneData[colonnaAttiva] || []).includes(n));
            });

            // Aggiorna log centrale
            const displayLog = document.getElementById('display-log');
            displayLog.innerHTML = '';
            (colonneData[colonnaAttiva] || []).forEach(nome => {
                const div = document.createElement('div');
                div.className = 'item-log';
                div.innerText = nome;
                displayLog.appendChild(div);
            });

            setTimeout(() => { displayLog.scrollTop = displayLog.scrollHeight; }, 50);

            // Salvataggio locale
            localStorage.setItem('shared_log_data', JSON.stringify({
                activeCol: colonnaAttiva,
                data: colonneData,
                timestamp: Date.now()
            }));
        }

        function resetDati() {
            if (confirm("Reset TOTALE? Cancellera' i dati anche agli altri connessi.")) {
                colonneData = [[], [], [], [], []];
                localStorage.removeItem('shared_log_data');
                syncAndRefresh();
                inviaDati();
            }
        }

        function salvaTutto() {
            let report = "REPORT SEQUENZE\n" + "=".repeat(30) + "\n";
            colonneData.forEach((arr, i) => { report += `\nCAMBIO ${i+1}: ` + (arr.join(", ") || "Vuota"); });
            const blob = new Blob([report], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'sequenza_nomi.txt';
            a.click();
        }

        // --- LOGICA PEERJS (Networking) ---
        let peer = null;
        let connessioni = []; // Lista di tutti i dispositivi connessi

        function initPeer() {
            // Crea un peer con ID casuale nel cloud pubblico di PeerJS
            peer = new Peer(); 

            peer.on('open', (id) => {
                document.getElementById('my-id').innerText = id;
                updateStatus(true, "Pronto. Il tuo ID √® sopra.");
            });

            peer.on('connection', (conn) => {
                setupConnessione(conn);
                updateStatus(true, "Nuovo dispositivo connesso!");
                // Quando qualcuno si connette a me, gli invio subito i miei dati aggiornati
                setTimeout(() => inviaDati(), 500); 
            });

            peer.on('error', (err) => {
                console.error(err);
                updateStatus(false, "Errore connessione: " + err.type);
            });
        }

        function connettiAPeer() {
            const remoteId = document.getElementById('remote-id').value.trim();
            if (!remoteId) return alert("Inserisci un ID");
            
            const conn = peer.connect(remoteId);
            setupConnessione(conn);
        }

        function setupConnessione(conn) {
            connessioni.push(conn);
            
            conn.on('open', () => {
                updateStatus(true, "Connesso a " + conn.peer);
                // Se mi connetto io, chiedo i dati o invio i miei? 
                // In questo modello semplice, chi invia per ultimo vince.
            });

            conn.on('data', (dataReceived) => {
                // RICEVO DATI: Aggiorno il mio stato locale
                console.log("Dati ricevuti!", dataReceived);
                if (dataReceived && Array.isArray(dataReceived)) {
                    colonneData = dataReceived;
                    syncAndRefresh(); // Aggiorno la UI ma NON rinvio i dati (evito loop)
                }
            });

            conn.on('close', () => {
                connessioni = connessioni.filter(c => c !== conn);
                updateStatus(connessioni.length > 0, connessioni.length + " dispositivi connessi");
            });
        }

        function inviaDati() {
            // Invia l'intero array colonneData a tutti i connessi
            connessioni.forEach(conn => {
                if(conn.open) {
                    conn.send(colonneData);
                }
            });
        }

        function updateStatus(isOnline, text) {
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('peer-status-text');
            if (isOnline) {
                dot.classList.add('status-online');
            } else {
                dot.classList.remove('status-online');
            }
            txt.innerText = text;
        }

        function copiaID() {
            const testo = document.getElementById('my-id').innerText;
            navigator.clipboard.writeText(testo).then(() => alert("ID Copiato!"));
        }

        // Avvio Iniziale
        syncAndRefresh();
        initPeer(); // Avvia PeerJS
    </script>
</body>
</html>
