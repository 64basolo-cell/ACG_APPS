<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Console Sync Pro - P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --bg-light: #f0f2f5;
            --text-main: #2c3e50;
        }

        body {
            font-family: "Segoe UI", Tahoma, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background-color: var(--bg-light);
            overflow: hidden;
            color: var(--text-main);
        }

        /* --- COLONNA INPUT (FISSA 2x10) --- */
        #colonna-input {
            width: 40%;
            height: 100vh;
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(10, 1fr);
            gap: 8px;
            background-color: #ffffff;
            border-right: 3px solid var(--primary);
            box-sizing: border-box;
        }

        .btn-sigla {
            font-family: inherit;
            font-weight: 800;
            border: 2px solid #bdc3c7;
            background: #fff;
            cursor: pointer;
            border-radius: 6px;
            text-transform: uppercase;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
            line-height: 1.1;
            font-size: clamp(0.6rem, 1.2vw, 0.85rem);
        }

        .btn-sigla:hover { background: #f8f9fa; border-color: var(--primary); }
        .btn-sigla:active { transform: scale(0.95); }
        
        .btn-sigla.attivo-nella-colonna { 
            background-color: var(--warning); 
            color: white; 
            border-color: #d35400;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        /* --- COLONNA VIEW --- */
        #colonna-view {
            width: 30%;
            padding: 15px;
            background-color: #ecf0f1;
            display: flex;
            flex-direction: column;
            border-right: 3px solid var(--primary);
            box-sizing: border-box;
        }

        #display-log {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding-right: 5px;
        }

        .item-log {
            background: white;
            padding: 12px;
            border-radius: 6px;
            font-weight: 700;
            border-left: 5px solid var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 0.9rem;
        }

        /* --- COLONNA CONTROLLI --- */
        #colonna-controlli {
            width: 30%;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-color: var(--primary);
            color: white;
            overflow-y: auto;
        }

        .panel {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .id-display { 
            background: #fff; color: #333; padding: 10px; 
            font-family: monospace; text-align: center; border-radius: 4px; 
            cursor: pointer; margin-top: 5px; font-weight: bold; font-size: 0.85rem;
            transition: background 0.2s;
        }
        .id-display:hover { background: #eee; }

        .btn-select {
            padding: 12px; border: none; background: #34495e; color: #bdc3c7; 
            cursor: pointer; font-weight: 700; border-radius: 6px; transition: 0.2s;
            text-align: left;
        }
        .btn-select.active { background-color: var(--accent); color: white; }

        .status-dot { height: 10px; width: 10px; background-color: #7f8c8d; border-radius: 50%; display: inline-block; margin-right: 5px;}
        .status-online { background-color: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

    <div id="colonna-input"></div>

    <div id="colonna-view">
        <h3 id="titolo-colonna" style="text-align: center; margin-top: 0; color: var(--primary); text-transform: uppercase;">CAMBIO 1</h3>
        <div id="display-log"></div>
    </div>

    <div id="colonna-controlli">
        <div class="panel">
            <label style="font-size: 0.75rem; opacity: 0.8;">IL TUO ID (Clicca per copiare):</label>
            <div id="my-id" class="id-display">Inizializzazione...</div>
            
            <input type="text" id="remote-id" style="width:100%; padding:10px; margin-top:12px; box-sizing:border-box; border-radius:4px; border:none;" placeholder="Incolla ID partner">
            <button onclick="connettiAPeer()" style="width:100%; margin-top:8px; padding:10px; background:#3498db; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">üîó CONNETTI</button>
            
            <div style="text-align:center; margin-top:10px; font-size:0.8rem;">
                <span id="status-dot" class="status-dot"></span> <span id="peer-status-text">Disconnesso</span>
            </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 5px;">
            <button class="btn-select active" onclick="switchColonna(0)">CAMBIO 1</button>
            <button class="btn-select" onclick="switchColonna(1)">CAMBIO 2</button>
            <button class="btn-select" onclick="switchColonna(2)">CAMBIO 3</button>
            <button class="btn-select" onclick="switchColonna(3)">CAMBIO 4</button>
            <button class="btn-select" onclick="switchColonna(4)">CAMBIO 5</button>
        </div>

        <div style="margin-top: auto; display: flex; flex-direction: column; gap: 8px;">
            <button onclick="salvaTutto()" style="padding:12px; background:var(--success); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">üíæ SCARICA REPORT</button>
            <button onclick="resetDati()" style="padding:10px; background:#c0392b; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">üóëÔ∏è RESET DATI</button>
        </div>
    </div>

    <script>
        const nomi = ["BAIRO","BARBANIA", "BUSANO", "CANISCHIO", "CUCEGLIO", "CUORGNE'", "FAVRIA", "FORNO", "FRASSINETTO", "LEVONE", "OZEGNA", "PERTUSIO", "PRASCORSANO", "PRATIGLIONE","RIVARA", "RIVAROLO","OGLIANICO" ,"SPARONE", "TORRE", "VALPERGA"];
        
        // --- STATO APPLICAZIONE ---
        let savedStore = localStorage.getItem('shared_log_data_v2');
        let appState = savedStore ? JSON.parse(savedStore) : { data: [[], [], [], [], []], lastUpdate: Date.now() };
        
        let colonneData = appState.data;
        let lastUpdate = appState.lastUpdate;
        let colonnaAttiva = 0;

        // --- GESTIONE P2P ---
        const peer = new Peer();
        let activeConnections = new Map();

        peer.on('open', id => {
            const d = document.getElementById('my-id');
            d.innerText = id;
            d.onclick = () => {
                navigator.clipboard.writeText(id);
                const old = d.innerText;
                d.innerText = "COPIATO!";
                setTimeout(() => d.innerText = old, 800);
            };
        });

        peer.on('connection', conn => setupConn(conn));

        function connettiAPeer() {
            const rId = document.getElementById('remote-id').value.trim();
            if(rId && !activeConnections.has(rId)) {
                setupConn(peer.connect(rId));
            }
        }

        function setupConn(conn) {
            conn.on('open', () => {
                activeConnections.set(conn.peer, conn);
                updateUIStatus();
                // Sincronizzazione iniziale
                conn.send({ data: colonneData, ts: lastUpdate });
            });

            conn.on('data', payload => {
                // Sincronizzazione intelligente: vince il timestamp pi√π recente
                if(payload.ts > lastUpdate) {
                    colonneData = payload.data;
                    lastUpdate = payload.ts;
                    syncAndRefresh();
                } else if (payload.ts < lastUpdate) {
                    // Se io sono pi√π aggiornato, istruisco il peer
                    conn.send({ data: colonneData, ts: lastUpdate });
                }
            });

            conn.on('close', () => {
                activeConnections.delete(conn.peer);
                updateUIStatus();
            });

            conn.on('error', () => {
                activeConnections.delete(conn.peer);
                updateUIStatus();
            });
        }

        function inviaDati() {
            const payload = { data: colonneData, ts: lastUpdate };
            activeConnections.forEach(conn => {
                if(conn.open) conn.send(payload);
            });
        }

        function updateUIStatus() {
            const count = activeConnections.size;
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('peer-status-text');
            dot.className = 'status-dot' + (count > 0 ? ' status-online' : '');
            text.innerText = count > 0 ? `${count} Peer Attivi` : "Disconnesso";
        }

        // --- LOGICA INTERFACCIA ---
        function renderTasti() {
            const container = document.getElementById('colonna-input');
            container.innerHTML = '';
            nomi.forEach((n, i) => {
                const b = document.createElement('button');
                b.innerText = n;
                b.id = `btn-tasto-${i}`;
                b.className = 'btn-sigla';
                b.onclick = () => toggleTasto(n, i);
                container.appendChild(b);
            });
            syncAndRefresh();
        }

        function toggleTasto(nome, index) {
            let colData = colonneData[colonnaAttiva];
            const pos = colData.indexOf(nome);
            
            if (pos > -1) colData.splice(pos, 1);
            else colData.push(nome);
            
            lastUpdate = Date.now();
            syncAndRefresh();
            inviaDati();
        }

        function syncAndRefresh() {
            // Aggiorna pulsanti input
            nomi.forEach((n, i) => {
                const b = document.getElementById(`btn-tasto-${i}`);
                if(b) b.classList.toggle('attivo-nella-colonna', (colonneData[colonnaAttiva] || []).includes(n));
            });

            // Aggiorna lista view
            const log = document.getElementById('display-log');
            log.innerHTML = '';
            (colonneData[colonnaAttiva] || []).forEach((n, i) => {
                const div = document.createElement('div');
                div.className = 'item-log';
                div.innerHTML = `<span>${n}</span><small style="color:#bdc3c7; font-family: monospace;">#${i+1}</small>`;
                log.appendChild(div);
            });
            log.scrollTop = log.scrollHeight;

            // Salvataggio locale
            localStorage.setItem('shared_log_data_v2', JSON.stringify({ data: colonneData, lastUpdate: lastUpdate }));
        }

        function switchColonna(idx) {
            colonnaAttiva = idx;
            document.getElementById('titolo-colonna').innerText = `CAMBIO ${idx + 1}`;
            document.querySelectorAll('.btn-select').forEach((b, i) => b.classList.toggle('active', i === idx));
            syncAndRefresh();
        }

        function resetDati() {
            if(confirm("Sei sicuro? Questo canceller√† tutti i dati su tutti i dispositivi connessi.")) {
                colonneData = [[], [], [], [], []];
                lastUpdate = Date.now();
                syncAndRefresh();
                inviaDati();
            }
        }

        function salvaTutto() {
            let txt = `REPORT CONSOLE - ${new Date().toLocaleString()}\n` + "=".repeat(40) + "\n";
            colonneData.forEach((d, i) => {
                txt += `\n[ CAMBIO ${i+1} ]\n` + (d.length > 0 ? d.map((n, idx) => `  ${idx+1}. ${n}`).join("\n") : "  (Vuoto)") + "\n";
            });
            const blob = new Blob([txt], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `report_console_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
        }

        // Avvio
        renderTasti();
    </script>
</body>
</html>